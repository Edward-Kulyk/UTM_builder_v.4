{% extends "base.html" %}

{% block title %}Campaigns Overview{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/overview.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
{% endblock %}

{% block content %}
    <h1>Campaigns Overview</h1>
    {% for campaign_data in grouped_campaigns %}
        <h2>{{ campaign_data.campaign_name }}</h2>
        <table>
            <thead>
                <tr>
                    <th>Short Secure URLs</th>
                    <th>Campaign Contents</th>
                    <th>Campaign Sources</th>
                    <th>Campaign Mediums</th>
                    <th>Clicks 24h</th>
                    <th>Clicks W1</th>
                    <th>Clicks W2</th>
                    <th>Clicks W3</th>
                    <th>Total Clicks</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% set campaign_contents_list = campaign_data.campaign_contents.split(',') %}
                {% set campaign_sources_list = campaign_data.campaign_sources.split(',') %}
                {% set campaign_mediums_list = campaign_data.campaign_mediums.split(',') %}
                {% set short_secure_urls_list = campaign_data.short_secure_urls.split(',') %}
                {% set short_ids_list = campaign_data.short_ids.split(',') %}
                {% set clicks_counts_list = campaign_data.clicks_counts.split(',') %}
                {% set campaign_clicks24 = campaign_data.clicks_counts_24h.split(',') %}
                {% set campaign_clicks1w = campaign_data.clicks_counts_1w.split(',') %}
                {% set campaign_clicks2w = campaign_data.clicks_counts_2w.split(',') %}
                {% set campaign_clicks3w = campaign_data.clicks_counts_3w.split(',') %}

                {% for i in range(short_secure_urls_list | length) %}
                    <tr id="row-{{ short_ids_list[i] }}">
                        <td>{{ short_secure_urls_list[i] }}</td>
                        <td>{{ campaign_contents_list[i] }}</td>
                        <td>{{ campaign_sources_list[i] }}</td>
                        <td>{{ campaign_mediums_list[i] }}</td>
                        <td>{{ campaign_clicks24[i] }}</td>
                        <td>{{ campaign_clicks1w[i] }}</td>
                        <td>{{ campaign_clicks2w[i] }}</td>
                        <td>{{ campaign_clicks3w[i] }}</td>
                        <td>{{ clicks_counts_list[i] }}</td>
                        <td>
                            <!-- Добавление кнопок редактирования и удаления для каждой строки -->
                            <button class="edit-btn" data-id="{{ short_ids_list[i] }}"><img src="static\images\edit.png" alt="Edit"></button>
                            <button class="delete-btn" data-id="{{ short_ids_list[i] }}"><img src="static\images\delete.png" alt="Delete"></button>
                        </td>
                    </tr>
                {% endfor %}
                <tr class="total-clicks">
                    <td colspan="4">Total Clicks</td>
                    <td>{{ campaign_data.total_clicks_24h }}</td>
                    <td>{{ campaign_data.total_clicks_1w }}</td>
                    <td>{{ campaign_data.total_clicks_2w }}</td>
                    <td>{{ campaign_data.total_clicks_3w }}</td>
                    <td>{{ campaign_data.total_clicks }}</td>
                </tr>
            </tbody>
        </table>
    {% endfor %}
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script>
            document.addEventListener("DOMContentLoaded", function() {
                // Ссылки на ваши изображения
                const editIcon = '<img src="static/images/edit.png" alt="Edit">';
                const saveIcon = '<img src="static/images/save.png" alt="Save">';
                const deleteIcon = '<img src="static/images/delete.png" alt="Delete">';

                // Обработчик нажатия на кнопку сохранения изменений
                document.querySelectorAll('.edit-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const row = this.closest('tr');
                        const deleteBtn = row.querySelector('.delete-btn');

                        if (row.classList.contains('editing')) {
                            // В режиме редактирования
                            const confirmSave = confirm("Save changes?");
                            if (confirmSave) {
                                // Проверяем, заполнены ли все поля
                                const inputs = row.querySelectorAll('td:not(:last-child)');
                                let allFieldsFilled = true;
                                inputs.forEach(input => {
                                    if (input.innerText.trim() === '') {
                                        allFieldsFilled = false;
                                    }
                                });

                                if (allFieldsFilled) {
                                    const id = row.id.split('-')[1];
                                    const data = {
                                        url: row.cells[0].innerText,
                                        campaign_content: row.cells[1].innerText,
                                        campaign_source: row.cells[2].innerText,
                                        campaign_medium: row.cells[3].innerText,
                                        short_secure_url: row.cells[4].innerText,
                                        clicks_count: row.cells[5].innerText,
                                    };

                                    fetch(`/edit-row/${id}`, {
                                        method: 'POST',
                                        headers: {'Content-Type': 'application/json'},
                                        body: JSON.stringify(data)
                                    })
                                    .then(response => response.json())
                                    .then(result => {
                                        alert(result.message);
                                        if (result.status === 'success') {
                                            Array.from(row.cells).forEach(cell => cell.contentEditable = false);
                                            row.classList.remove('editing');
                                            button.innerHTML = editIcon; // Вернуть значок редактирования
                                            deleteBtn.innerHTML = deleteIcon; // Вернуть значок удаления
                                        }
                                    })
                                    .catch(error => console.error('Error:', error));
                                } else {
                                    alert('Please fill in all fields before saving.');
                                }
                            }
                        } else {
                            // Вход в режим редактирования
                            Array.from(row.cells).forEach((cell, index) => {
                                if (index < row.cells.length - 3) {
                                    cell.dataset.originalValue = cell.innerText;
                                    cell.contentEditable = true;
                                }
                            });
                            row.classList.add('editing');
                            this.innerHTML = saveIcon; // Задать значок сохранения
                            deleteBtn.innerHTML = '<img src="static/images/cancel.png" alt="Cancel">'; // Задать значок отмены
                        }
                    });
                });

                // Обработчик нажатия на кнопку удаления
                document.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const row = this.closest('tr');
                        if (row.classList.contains('editing')) {
                            // Если мы в режиме редактирования, просто выходим из него
                            Array.from(row.cells).forEach(cell => cell.contentEditable = false);
                            row.classList.remove('editing');
                            const editBtn = row.querySelector('.edit-btn');
                            editBtn.innerHTML = editIcon; // Вернуть значок редактирования
                            this.innerHTML = deleteIcon;
                            // Восстанавливаем изначальные значения
                            Array.from(row.cells).forEach((cell, index) => {
                                if (index < row.cells.length - 3) {
                                    cell.innerText = cell.dataset.originalValue;
                                }
                            });
                        } else {
                            const id = row.id.split('-')[1];
                            const confirmDelete = confirm("Are you sure you want to delete this row?");
                            if (confirmDelete) {
                                fetch(`/delete-row/${id}`, {
                                    method: 'POST',
                                })
                                .then(response => response.json())
                                .then(result => {
                                    alert(result.message);
                                    if (result.status === 'success') {
                                        row.remove();
                                    }
                                })
                                .catch(error => console.error('Error:', error));
                            }
                        }
                    });
                });
            });
        </script>


{% endblock %}
